- include_tasks: keygen.yml
  delegate_to: localhost
  run_once: true
  become: no

- include_vars:
    file: key.yml

- name: stopping consul client service
  service:
    name: consul-client
    state: stopped
    enabled: false
    daemon_reload: true
  ignore_errors: true

- name: bootstrap the first consul node
  block:
    - name: stopping consul server service
      service:
        name: consul-server
        state: stopped
      ignore_errors: true
    - template:
        src: bootstrap_config.json.j2
        dest: /etc/consul.d/bootstrap/config.json
    - shell: "consul agent -config-dir=/etc/consul.d/bootstrap &"
      become_user: consul
      when: consul_bootstrap is defined
    - wait_for:
        host: 0.0.0.0
        port: 8300
        state: started
        timeout: 30
  when: consul_bootstrap is defined

- name: start other consul servers and join in the cluster
  block:
    - template:
        src: server_config.json.j2
        dest: /etc/consul.d/server/config.json
    - template:
        src: consul-server.service.j2
        dest: /etc/systemd/system/consul-server.service
    - service:
        name: consul-server
        state: restarted
        enabled: true
        daemon_reload: true
    - wait_for:
        host: 0.0.0.0
        port: 8300
        state: started
        timeout: 30
  when: consul_bootstrap is not defined

- name: start the first consul server
  block:
    - command: pkill consul
    - wait_for:
        host: 0.0.0.0
        port: 8300
        state: stopped
        timeout: 30
    - template:
        src: server_config.json.j2
        dest: /etc/consul.d/server/config.json
    - template:
        src: consul-server.service.j2
        dest: /etc/systemd/system/consul-server.service
    - service:
        name: consul-server
        state: restarted
        enabled: true
        daemon_reload: true
    - wait_for:
        host: 0.0.0.0
        port: 8300
        state: started
        timeout: 30
  when: consul_bootstrap is defined
