- include_tasks: keygen.yml
  delegate_to: localhost
  run_once: true
  become: no

- include_vars:
    file: key.yml

# - name: stopping consul client service
#   service:
#     name: consul-client
#     state: stopped
#     enabled: false
#     daemon_reload: true
#   ignore_errors: true
#
# - name: bootstrap the first consul node
#   block:
#     - template:
#         src: config.json.j2
#         dest: /etc/consul.d/server/config.json
#         validate: consul validate %s
#     - service:
#         name: consul-server
#         state: restarted
#         enabled: true
#         daemon_reload: true
#     - wait_for:
#         host: 0.0.0.0
#         port: 8300
#         state: started
#         timeout: 30
#   when: consul_bootstrap is defined

- include_tasks: server.yml
#   when: consul_bootstrap is not defined
#
# - name: start the first consul server
#   block:
#     - command: pkill consul
#     - wait_for:
#         host: 0.0.0.0
#         port: 8300
#         state: stopped
#         timeout: 30
#     - include_tasks: server.yml
#   when: consul_bootstrap is defined
